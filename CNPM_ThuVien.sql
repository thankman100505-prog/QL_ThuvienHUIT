CREATE DATABASE CNPM_DATABASE_THUVIEN
GO
 
USE CNPM_DATABASE_THUVIEN
--use master
--DROP DATABASE CNPM_DATABASE_THUVIEN
--1) Tạo bảng tác giả
CREATE TABLE TACGIA
(
	MATG CHAR(7) PRIMARY KEY,
	TENTG NVARCHAR(50)NOT NULL,
	NGAYSINH DATE CHECK(NGAYSINH<GETDATE()),
	QUOCTICH NVARCHAR(50) DEFAULT N'Việt Nam'
)

--2) Tạo bảng THELOAI
CREATE TABLE THELOAI
(
    MATHELOAI CHAR(7) PRIMARY KEY,
    TENTHELOAI NVARCHAR(50) UNIQUE NOT NULL,
    MOTA NVARCHAR(255) DEFAULT N'Chưa có mô tả'
);

--3) Tạo bảng NHAXUATBAN
CREATE TABLE NHAXUATBAN
(
    MAXB CHAR(7) PRIMARY KEY,
    TENNXB NVARCHAR(100) UNIQUE NOT NULL,
    DCHI NVARCHAR(200) NOT NULL,
    SDT CHAR(10) CHECK (SDT LIKE '%[0-9]%')
);

--4) Bảng Quản Lý Sách
CREATE TABLE QLSACH
(
	MASACH CHAR(7) PRIMARY KEY,
	TENSACH NVARCHAR(50)NOT NULL,
	MATG CHAR(7),
	MATHELOAI CHAR(7),
	MAXB CHAR(7),
	NAMXB INT CHECK(NAMXB<=YEAR(GETDATE())),
	SL INT CHECK(SL>=0),
	TINHTRANG INT CHECK(TINHTRANG>=0),
	FOREIGN KEY (MATG) REFERENCES TACGIA (MATG),
	FOREIGN KEY (MATHELOAI) REFERENCES THELOAI (MATHELOAI),
	FOREIGN KEY (MAXB) REFERENCES NHAXUATBAN (MAXB),
	CONSTRAINT CK_TINHTRANG CHECK (TINHTRANG <= SL)
)

CREATE TABLE BIASACH
(
	MASACH CHAR(7) PRIMARY KEY,
	URL_ANH NVARCHAR(100),
	FOREIGN KEY (MASACH) REFERENCES QLSACH(MASACH)
)

--5) Đọc Giả
CREATE TABLE DOCGIA
(
    MADG CHAR(7) PRIMARY KEY,
    TENDG NVARCHAR(30) NOT NULL,
    KHOA NVARCHAR(50),
    LOP NVARCHAR(50),
    DIACHI NVARCHAR(100),
    SODT CHAR(10) CHECK (SODT NOT LIKE '%[^0-9]%'),
);

ALTER TABLE DOCGIA
ADD MAIL NVARCHAR(100) UNIQUE CHECK (MAIL LIKE '%@%') 

-- 6) Thẻ thư viện
CREATE TABLE THETHUVIEN
(
    MATHE CHAR(7) PRIMARY KEY,
    MADG CHAR(7) NULL,
    NGAYCAP DATE,
    NGAYHETHAN DATE,
    TRANGTHAI NVARCHAR(20) DEFAULT N'Hoạt động',
    FOREIGN KEY (MADG) REFERENCES DOCGIA (MADG),
    CONSTRAINT CK_NGAYHETHAN CHECK (NGAYHETHAN > NGAYCAP)
);

--7) BẢNG NHÂN VIÊN
CREATE TABLE QLNHANVIEN
(
    MANV CHAR(7) PRIMARY KEY,                          
    TENNV NVARCHAR(50) NOT NULL,                        
    NGSINH DATE CHECK (NGSINH < GETDATE()),              
    CHUCVU NVARCHAR(50) NOT NULL,
    SDIENTHOAI CHAR(10) UNIQUE CHECK (SDIENTHOAI LIKE '0%'), 
    MAIL NVARCHAR(100) UNIQUE CHECK (MAIL LIKE '%@%')       
);

-- 8. Phiếu mượn
CREATE TABLE PHIEUMUON
(
    MAPM CHAR(7) PRIMARY KEY,
    MADG CHAR(7) NOT NULL,
    MANV CHAR(7) NOT NULL,
    NgayMuon DATE DEFAULT GETDATE(),
    NgayDenHan DATE,
    FOREIGN KEY (MADG) REFERENCES DOCGIA(MADG),
    FOREIGN KEY (MANV) REFERENCES QLNHANVIEN(MANV),
    CONSTRAINT CK_NgayHan CHECK (NgayDenHan > NgayMuon)
);

--9. CT PHIẾU MƯỢN
CREATE TABLE CHITIETPM
( MAPM CHAR(7),
  MASACH CHAR(7) NOT NULL,
  SLMUON INT CHECK (SLMUON >0),
  TIENTHECHAN MONEY,
  PRIMARY KEY (MAPM,MASACH),
  FOREIGN KEY (MAPM) REFERENCES PHIEUMUON (MAPM),
  FOREIGN KEY (MASACH) REFERENCES QLSACH (MASACH)
);

--10)Phiếu trả

CREATE TABLE PHIEUTRA
( MAPT CHAR(7) PRIMARY KEY,
  MAPM CHAR(7) NOT NULL UNIQUE,
  MANV CHAR(7) NOT NULL,
  NGAYTRA DATE DEFAULT GETDATE(),
  TONG_TIENTHECHAN MONEY CHECK (TONG_TIENTHECHAN>0),
  TIENPHAT MONEY DEFAULT 0 CHECK (TIENPHAT >=0),
  FOREIGN KEY (MAPM) REFERENCES PHIEUMUON (MAPM),
  FOREIGN KEY (MANV) REFERENCES QLNHANVIEN (MANV)
);


-- QUẢN LÝ PHÒNG HỌP
CREATE TABLE PHONGHOP
(
	MAPHONG CHAR(7) NOT NULL PRIMARY KEY,
	VITRI NVARCHAR(20) NOT NULL CHECK (VITRI IN (N'Tầng 1',N'Tầng 2',N'Tầng 3',N'Tầng 4')),
	SL_NGUOITOIDA INT CHECK (SL_NGUOITOIDA>0),
	TINHTRANG INT CHECK (TINHTRANG=0 OR TINHTRANG=1)--TINHTRANG=0 TỨC ĐANG CÓ NGƯỜI MƯỢN CÒN TINHTRANG=1 TỨC KHÔNG CÓ AI MƯỢN PHÒNG
)

-- PHIẾU MƯỢN PHÒNG
CREATE TABLE PHIEU_MUONPHONG
(
	MAPHIEU CHAR(7) NOT NULL PRIMARY KEY,
	MADG CHAR(7) NOT NULL,--CHỈ CÓ ĐỘC GIẢ ĐÃ ĐĂNG KÍ HOẶC SINH VIÊN MỚI ĐƯỢC MƯỢN PHÒNG
	MAPH CHAR(7) NOT NULL,
	NGAYMUON DATE,
	GIOMUON TIME,
	SL_NGUOITHAMGIA INT CHECK (SL_NGUOITHAMGIA>0),
	MUCDICH NVARCHAR(500),
	TIENPHAT MONEY DEFAULT 0 CHECK (TIENPHAT >=0),
	FOREIGN KEY(MAPH) REFERENCES PHONGHOP(MAPHONG),
	FOREIGN KEY (MADG) REFERENCES DOCGIA(MADG)
)

CREATE TABLE ROLE_USER
(
	ROLE_ID INT IDENTITY(1,1) PRIMARY KEY,
	ROLE_NAME NVARCHAR(20) UNIQUE, 
	DESCRIPT NVARCHAR(200)
)

INSERT INTO ROLE_USER VALUES
(N'Admin',N'Toàn quyền trên DB'),
(N'Librarian',N'Quản lý độc giả, sách, mượn trả sách, phòng họp'),
(N'Reader',N'Xem sách, mượn sách, phòng họp')

CREATE TABLE TAIKHOAN
(
	USERNAME VARCHAR(50) PRIMARY KEY, -- LÀ MÃ ĐỘC GIẢ ĐƯỢC CẤP 
	PASS VARBINARY(64),
	ROLE_ID INT,
	FOREIGN KEY (ROLE_ID) REFERENCES ROLE_USER(ROLE_ID) 
)

--DROP TABLE PHIEU_MUONPHONG
--DROP TABLE PHONGHOP
--DROP TABLE PHIEUTRA
--DROP TABLE CHITIETPM
--DROP TABLE PHIEUMUON
--DROP TABLE THETHUVIEN
--DROP TABLE DOCGIA
--DROP TABLE TAIKHOAN

SELECT * FROM [TACGIA];
SELECT * FROM [THELOAI];
SELECT * FROM [NHAXUATBAN];
SELECT * FROM [QLSACH];
SELECT * FROM [DOCGIA];
SELECT * FROM [THETHUVIEN];
SELECT * FROM [QLNHANVIEN];
SELECT * FROM [PHIEUMUON];
SELECT * FROM [CHITIETPM];
SELECT * FROM [PHIEUTRA];
SELECT * FROM [PHONGHOP];
SELECT * FROM [PHIEU_MUONPHONG];


------- THÊM DỮ LIỆU
INSERT INTO TACGIA VALUES
('TG00001', N'Allen B. Downey', '1970-01-01', N'Mỹ'),
('TG00002', N'Andrew S. Tanenbaum', '1944-03-16', N'Hà Lan'),
('TG00003', N'Ian Goodfellow', '1985-01-01', N'Mỹ'),
('TG00004', N'Haykin Simon', '1942-01-01', N'Canada'),
('TG00005', N'Nguyễn Thanh Tùng', '1978-05-12', N'Việt Nam'),
('TG00006', N'Tristan Nguyen', '1981-04-21', N'Việt Nam'),
('TG00007', N'Daniel Goleman', '1946-03-07', N'Mỹ'),
('TG00008', N'Dale Carnegie', '1888-11-24', N'Mỹ'),
('TG00009', N'Nguyễn Trung Hiếu', '1983-09-09', N'Việt Nam'),
('TG00010', N'Hồ Trung Thành', '1972-02-22', N'Việt Nam'),
('TG00011', N'Phạm Quốc Bảo', '1985-12-01', N'Việt Nam'),
('TG00012', N'Lê Thị Mỹ Hạnh', '1987-06-14', N'Việt Nam'),
('TG00013', N'Huỳnh Hữu Tuấn', '1989-08-18', N'Việt Nam'),
('TG00014', N'Nguyễn Hoàng Dũng', '1990-04-04', N'Việt Nam'),
('TG00015', N'Elon Musk', '1971-06-28', N'Mỹ');


INSERT INTO THELOAI VALUES
('TL00001', N'Sách chuyên ngành', N'Sách phục vụ nghiên cứu'),
('TL00002', N'Giáo trình', N'Sách phục vụ học tập'),
('TL00003', N'Tài liệu tham khảo', N'Tài liệu dùng để tra cứu'),
('TL00004', N'Sách kĩ năng', N'Sách phát triển bản thân'),
('TL00005', N'Luận văn - Khóa luận', N'Bài làm cuối khóa'),
('TL00006', N'Tạp chí khoa học', N'Tạp chí chuyên ngành khoa học');

INSERT INTO NHAXUATBAN VALUES
('NXB0001', N'NXB Giáo Dục', N'Hà Nội', '0283456789'),
('NXB0002', N'NXB Trẻ', N'TP.HCM', '0283456790'),
('NXB0003', N'NXB Khoa Học Tự Nhiên', N'Hà Nội', '0243876543'),
('NXB0004', N'NXB Đại Học Quốc Gia', N'TP.HCM', '0283451234'),
('NXB0005', N'NXB Reilly', N'Hoa Kỳ', '0012345678'),
('NXB0006', N'NXB McGraw-Hill', N'Hoa Kỳ', '0018765432'),
('NXB0007', N'NXB Pearson', N'Anh Quốc', '0044556677'),
('NXB0008', N'NXB DataSci Press', N'Singapore', '0066123456'),
('NXB0009', N'NXB Kinh Tế', N'Hà Nội', '0243688011'),
('NXB0010', N'NXB Tự Lực', N'TP.HCM', '0284562391');


INSERT INTO QLSACH VALUES
('S000001', N'Think Python', 'TG00001', 'TL00001', 'NXB0005', 2015, 12, 12),
('S000002', N'Computer Networks', 'TG00002', 'TL00001', 'NXB0007', 2011, 10, 9),
('S000003', N'Deep Learning', 'TG00003', 'TL00001', 'NXB0006', 2016, 8, 8),
('S000004', N'Neural Networks and Learning Machines', 'TG00004', 'TL00001', 'NXB0006', 2008, 7, 7),
('S000005', N'Giáo trình Cơ sở dữ liệu', 'TG00005', 'TL00002', 'NXB0001', 2020, 20, 19),
('S000006', N'Giáo trình Mạng máy tính', 'TG00010', 'TL00002', 'NXB0004', 2021, 15, 14),
('S000007', N'Giáo trình Thuật toán', 'TG00011', 'TL00002', 'NXB0003', 2019, 10, 10),
('S000008', N'Phân tích dữ liệu với Python', 'TG00006', 'TL00003', 'NXB0008', 2022, 12, 11),
('S000009', N'Hướng dẫn lập trình C++', 'TG00009', 'TL00003', 'NXB0001', 2018, 18, 17),
('S000010', N'Tài liệu học máy nâng cao', 'TG00004', 'TL00003', 'NXB0006', 2021, 9, 9),
('S000011', N'Emotional Intelligence', 'TG00007', 'TL00004', 'NXB0006', 1995, 10, 9),
('S000012', N'How to Win Friends and Influence People', 'TG00008', 'TL00004', 'NXB0010', 1936, 20, 20),
('S000013', N'Sức mạnh tư duy tích cực', 'TG00012', 'TL00004', 'NXB0002', 2017, 25, 24),
('S000014', N'Khóa luận ứng dụng AI trong xử lý ảnh', 'TG00013', 'TL00005', 'NXB0004', 2023, 3, 3),
('S000015', N'Luận văn nhận diện chữ viết tay', 'TG00014', 'TL00005', 'NXB0004', 2022, 2, 2),
('S000016', N'Khóa luận phân tích dữ liệu lớn', 'TG00012', 'TL00005', 'NXB0009', 2023, 4, 4),
('S000017', N'Journal of Machine Learning Research – Vol 1', 'TG00003', 'TL00006', 'NXB0006', 2019, 5, 5),
('S000018', N'Journal of Data Science – Vol 2', 'TG00006', 'TL00006', 'NXB0008', 2020, 6, 6),
('S000019', N'Vietnam Journal of Science – Số 15', 'TG00009', 'TL00006', 'NXB0003', 2022, 4, 4),
('S000020', N'International AI Review – Vol 5', 'TG00003', 'TL00006', 'NXB0006', 2021, 7, 7);

INSERT INTO BIASACH VALUES
('S000001', 'Sach1.jpg'),
('S000002', 'Sach2.jpg'),
('S000003', 'Sach3.jpg'),
('S000004', 'Sach4.jpg'),
('S000005', 'Sach5.jpg'),
('S000006','Sach6jpg'),
('S000007','Sach7.jpg'),
('S000008','Sach8.jpg'),
('S000009', 'Sach9.jpg'),
('S000010', 'Sach10.jpg'),
('S000011', 'Sach11.jpg'),
('S000012', 'Sach12.jpg'),
('S000013', 'Sach13.jpg'),
('S000014', 'Sach14.jpg'),
('S000015', 'Sach15.jpg'),
('S000016', 'Sach16.jpg'),
('S000017', 'Sach17.jpg'),
('S000018', 'Sach18.jpg'),
('S000019', 'Sach19.jpg'),
('S000020', 'Sach20.jpg');

INSERT INTO DOCGIA VALUES
('DG00001',N'Đỗ Thành Trung',N'Khoa Công Nghệ Thông Tin',N'14DHTH12',N'TP.HCM','0912345678','dothanhtrunf@gmail.com'),
('DG00002',N'Lê Thị Châu',N'Khoa Quản trị Kinh doanh',N'13DHKD',N'Long An','0914425125','chaithile@gmail.com'),
('DG00003',N'Nguyễn Hữu Cường',N'Khoa Tài chính - Kế toán',N'15DHKT',N'Binh Dương','0284470967','huucuong@gmail.com'),
('DG00004',N'Bùi Đắc Hoàng Phước',N'Khoa Ngoại Ngữ',N'14DHAV',N'TP.HCM','0922509415','hoangphuoc@gmail.com'),
('DG00005',N'Đinh Xuân Cường',N'Khoa Công nghệ Cơ khí',N'14DHCK',N'TP.HCM','0357721341','cuong123@gmail.com'),
('DG00006',N'Ngô Thị Hoa',N'Khoa Công nghệ Thực phẩm',N'12DHTP',N'An Giang','0967812443','hoangothi@gmail.com'),
('DG00007',N'Vũ Minh Hùng',N'Khoa Công nghệ Điện - Điện tử',N'14DHDT',N'Tiền Giang','0284043311','hungvu1@gmail.com'),
('DG00008',N'Bùi Thị Lan',N'Khoa Sinh học và Môi trường',N'12DHMT',N'TP.HCM','0354450010','buithilan@gmail.com'),
('DG00009',N'Đỗ Mạnh Quân',N'Khoa Công nghệ May và Thời trang',N'14DHTT',N'Long An','0990126641','doquan123@gmail.com'),
('DG00010',N'Phan Thị Thảo',N'Khoa Lý Luận Chính Trị',N'15DGCT',N'Bến Tre','0901254337','janny11@gmail.com');


INSERT INTO THETHUVIEN VALUES
('TH00001','DG00001','2025-01-15','2027-01-15',N'Hoạt động'),
('TH00002','DG00002','2025-02-10','2027-02-10',N'Hoạt động'),
('TH00003','DG00003','2025-03-05','2027-03-05',N'Hoạt động'),
('TH00004','DG00004','2025-04-20','2027-04-20',N'Hoạt động'),
('TH00005','DG00005','2025-05-12','2027-05-12',N'Hoạt động'),
('TH00006','DG00006','2025-06-18','2027-06-18',N'Hoạt động'),
('TH00007','DG00007','2025-07-25','2026-07-25',N'Hoạt động'),
('TH00008','DG00008','2024-08-30','2026-08-30',N'Hoạt động'),
('TH00009','DG00009','2025-09-14','2027-09-14',N'Hoạt động'),
('TH00010','DG00010','2023-10-01','2026-10-01',N'Hoạt động');

INSERT INTO QLNHANVIEN VALUES
('NV00001',N'Nguyễn Văn A','1990-05-10',N'Thủ thư','0911222333','vana@gmail.com'),
('NV00002',N'Trần Thị B','1992-07-20',N'Quản lý','0911333444','thib@gmail.com'),
('NV00003',N'Lê Văn C','1988-03-15',N'Thủ thư','0911444555','vanc@gmail.com');

INSERT INTO PHIEUMUON VALUES
('PM00001','DG00001','NV00001','2023-10-01','2023-10-15'),
('PM00002','DG00002','NV00002','2023-06-01','2023-06-15'),
('PM00003','DG00003','NV00003','2023-07-15','2023-07-30');

INSERT INTO CHITIETPM VALUES
('PM00001','S000001',2,20000),
('PM00001','S000002',1,10000),
('PM00002','S000003',1,10000),
('PM00003','S000001',1,10000),
('PM00003','S000004',3,30000);

INSERT INTO PHIEUTRA VALUES
('PT00001','PM00001','NV00001','2023-10-14',30000,0),
('PT00002','PM00002','NV00003','2023-06-11',10000,200000),
('PT00003','PM00003','NV00002','2023-08-02',40000,100000);

INSERT INTO PHONGHOP VALUES 
('PH00001',N'Tầng 3',10,1),
('PH00002',N'Tầng 3',8,1),
('PH00003',N'Tầng 3',12,1),
('PH00004',N'Tầng 3',8,1)

INSERT INTO PHIEU_MUONPHONG VALUES
('MP00001','DG00001','PH00001','2025/02/11','09:50:00',6,N'Họp nhóm',0),
('MP00002','DG00002','PH00001','2025/10/14','12:30:00',6,N'Họp nhóm và thảo luận đồ án với giảng viên hướng dẫn',0),
('MP00003','DG00001','PH00001','2025/02/11','09:50:00',6,N'Báo cáo đồ án cuối kì online',0),
('MP00004','DG00001','PH00001','2025/02/11','09:50:00',6,N'Họp nhóm',0)

--- TẠO TÀI KHOẢN 
INSERT INTO TAIKHOAN VALUES 
('admin',   HASHBYTES('SHA2_256', '12345'), 1),
('librarian1', HASHBYTES('SHA2_256', '12345'), 2),
('DG00001',  HASHBYTES('SHA2_256', '12345'), 3);