CREATE DATABASE CNPM_DATABASE_THUVIEN
GO
 
USE CNPM_DATABASE_THUVIEN
use master
--DROP DATABASE CNPM_DATABASE_THUVIEN
--1) Tạo bảng tác giả
CREATE TABLE TACGIA
(
	MATG CHAR(7) PRIMARY KEY,
	TENTG NVARCHAR(50)NOT NULL,
	NGAYSINH DATE CHECK(NGAYSINH<GETDATE()),
	QUOCTICH NVARCHAR(50) DEFAULT N'Việt Nam'
)


--2) Tạo bảng THELOAI
CREATE TABLE THELOAI
(
    MATHELOAI CHAR(7) PRIMARY KEY,
    TENTHELOAI NVARCHAR(50) UNIQUE NOT NULL,
    MOTA NVARCHAR(255) DEFAULT N'Chưa có mô tả'
);

--3) Tạo bảng NHAXUATBAN
CREATE TABLE NHAXUATBAN
(
    MAXB CHAR(7) PRIMARY KEY,
    TENNXB NVARCHAR(100) UNIQUE NOT NULL,
    DCHI NVARCHAR(200) NOT NULL,
    SDT CHAR(10) CHECK (SDT LIKE '%[0-9]%')
);

--4) Bảng Quản Lý Sách
CREATE TABLE QLSACH
(
	MASACH CHAR(7) PRIMARY KEY,
	TENSACH NVARCHAR(50)NOT NULL,
	MATG CHAR(7),
	MATHELOAI CHAR(7),
	MAXB CHAR(7),
	NAMXB DATE CHECK(NAMXB<=GETDATE()),
	SL INT CHECK(SL>=0),
	TINHTRANG INT CHECK(TINHTRANG>=0),
	FOREIGN KEY (MATG) REFERENCES TACGIA (MATG),
	FOREIGN KEY (MATHELOAI) REFERENCES THELOAI (MATHELOAI),
	FOREIGN KEY (MAXB) REFERENCES NHAXUATBAN (MAXB),
	CONSTRAINT CK_TINHTRANG CHECK (TINHTRANG <= SL)
)

--5) Đọc Giả
CREATE TABLE DOCGIA
(
    MADG CHAR(7) PRIMARY KEY,
    TENDG NVARCHAR(30) NOT NULL,
    KHOA NVARCHAR(50),
    LOP NVARCHAR(50),
    DIACHI NVARCHAR(100),
    SODT CHAR(10) CHECK (SODT NOT LIKE '%[^0-9]%'),
);

ALTER TABLE DOCGIA
ADD MAIL NVARCHAR(100) UNIQUE CHECK (MAIL LIKE '%@%') 

-- 6) Thẻ thư viện
CREATE TABLE THETHUVIEN
(
    MATHE CHAR(7) PRIMARY KEY,
    MADG CHAR(7) NULL,
    NGAYCAP DATE,
    NGAYHETHAN DATE,
    TRANGTHAI NVARCHAR(20) DEFAULT N'Hoạt động',
    FOREIGN KEY (MADG) REFERENCES DOCGIA (MADG),
    CONSTRAINT CK_NGAYHETHAN CHECK (NGAYHETHAN > NGAYCAP)
);

--7) BẢNG NHÂN VIÊN
CREATE TABLE QLNHANVIEN
(
    MANV CHAR(7) PRIMARY KEY,                          
    TENNV NVARCHAR(50) NOT NULL,                        
    NGSINH DATE CHECK (NGSINH < GETDATE()),              
    CHUCVU NVARCHAR(50) NOT NULL,
    SDIENTHOAI CHAR(10) UNIQUE CHECK (SDIENTHOAI LIKE '0%'), 
    MAIL NVARCHAR(100) UNIQUE CHECK (MAIL LIKE '%@%')       
);

-- 8. Phiếu mượn
CREATE TABLE PHIEUMUON
(
    MAPM CHAR(7) PRIMARY KEY,
    MADG CHAR(7) NOT NULL,
    MANV CHAR(7) NOT NULL,
    NgayMuon DATE DEFAULT GETDATE(),
    NgayDenHan DATE,
    FOREIGN KEY (MADG) REFERENCES DOCGIA(MADG),
    FOREIGN KEY (MANV) REFERENCES QLNHANVIEN(MANV),
    CONSTRAINT CK_NgayHan CHECK (NgayDenHan > NgayMuon)
);

--9. CT PHIẾU MƯỢN
CREATE TABLE CHITIETPM
( MAPM CHAR(7),
  MASACH CHAR(7) NOT NULL,
  SLMUON INT CHECK (SLMUON >0),
  TIENTHECHAN DECIMAL(4,2),
  PRIMARY KEY (MAPM,MASACH),
  FOREIGN KEY (MAPM) REFERENCES PHIEUMUON (MAPM),
  FOREIGN KEY (MASACH) REFERENCES QLSACH (MASACH)
);

--10)Phiếu trả

CREATE TABLE PHIEUTRA
( MAPT CHAR(7) PRIMARY KEY,
  MAPM CHAR(7) NOT NULL UNIQUE,
  MANV CHAR(7) NOT NULL,
  NGAYTRA DATE DEFAULT GETDATE(),
  TONG_TIENTHECHAN MONEY CHECK (TONG_TIENTHECHAN>0),
  TIENPHAT MONEY DEFAULT 0 CHECK (TIENPHAT >=0),
  FOREIGN KEY (MAPM) REFERENCES PHIEUMUON (MAPM),
  FOREIGN KEY (MANV) REFERENCES QLNHANVIEN (MANV)
);


-- QUẢN LÝ PHÒNG HỌP
CREATE TABLE PHONGHOP
(
	MAPHONG CHAR(7) NOT NULL PRIMARY KEY,
	VITRI NVARCHAR(20) NOT NULL CHECK (VITRI IN (N'Tầng 1',N'Tầng 2',N'Tầng 3',N'Tầng 4')),
	SL_NGUOITOIDA INT CHECK (SL_NGUOITOIDA>0),
	TINHTRANG INT CHECK (TINHTRANG=0 OR TINHTRANG=1)--TINHTRANG=0 TỨC ĐANG CÓ NGƯỜI MƯỢN CÒN TINHTRANG=1 TỨC KHÔNG CÓ AI MƯỢN PHÒNG
)

-- PHIẾU MƯỢN PHÒNG
CREATE TABLE PHIEU_MUONPHONG
(
	MAPHIEU CHAR(7) NOT NULL PRIMARY KEY,
	MADG CHAR(7) NOT NULL,--CHỈ CÓ ĐỘC GIẢ ĐÃ ĐĂNG KÍ HOẶC SINH VIÊN MỚI ĐƯỢC MƯỢN PHÒNG
	MAPH CHAR(7) NOT NULL,
	NGAYMUON DATE,
	GIOMUON TIME,
	SL_NGUOITHAMGIA INT CHECK (SL_NGUOITHAMGIA>0),
	MUCDICH NVARCHAR(500),
	TIENPHAT MONEY DEFAULT 0 CHECK (TIENPHAT >=0),
	FOREIGN KEY(MAPH) REFERENCES PHONGHOP(MAPHONG),
	FOREIGN KEY (MADG) REFERENCES DOCGIA(MADG)
)

--DROP TABLE PHIEU_MUONPHONG
--DROP TABLE PHONGHOP
--DROP TABLE PHIEUTRA
--DROP TABLE CHITIETPM
--DROP TABLE PHIEUMUON
--DROP TABLE THETHUVIEN
--DROP TABLE DOCGIA

SELECT * FROM [TACGIA];
SELECT * FROM [THELOAI];
SELECT * FROM [NHAXUATBAN];
SELECT * FROM [QLSACH];
SELECT * FROM [DOCGIA];
SELECT * FROM [THETHUVIEN];
SELECT * FROM [QLNHANVIEN];
SELECT * FROM [PHIEUMUON];
SELECT * FROM [CHITIETPM];
SELECT * FROM [PHIEUTRA];
SELECT * FROM [PHONGHOP];
SELECT * FROM [PHIEU_MUONPHONG];


------- THÊM DỮ LIỆU
INSERT INTO TACGIA VALUES
('TG00001',N'Nguyễn Nhật Ánh','1955-05-07',N'Việt Nam'),
('TG00002',N'J.K. Rowling','1965-07-31',N'Anh'),
('TG00003',N'Haruki Murakami','1949-01-12',N'Nhật Bản'),
('TG00004',N'George Orwell','1903-06-25',N'Anh'),
('TG00005',N'Ernest Hemingway','1899-07-21',N'Mỹ'),
('TG00006',N'Lev Tolstoy','1828-09-09',N'Nga'),
('TG00007',N'Victor Hugo','1802-02-26',N'Pháp'),
('TG00008',N'Gabriel García Márquez','1927-03-06',N'Colombia'),
('TG00009',N'Paulo Coelho','1947-08-24',N'Brazil'),
('TG00010',N'Nam Cao','1915-10-29',N'Việt Nam');

INSERT INTO THELOAI VALUES
('TL00001',N'Tiểu thuyết',N'Sách văn học, tiểu thuyết'),
('TL00004',N'Thiếu nhi',N'Sách cho trẻ em'),
('TL00005',N'Chính trị - Xã hội',N'Sách chính trị, xã hội'),
('TL00009',N'Kinh điển',N'Tác phẩm kinh điển');

INSERT INTO NHAXUATBAN VALUES
('XB00001',N'NXB Kim Đồng',N'Hà Nội','0912345678'),
('XB00002',N'NXB Giáo Dục',N'Hồ Chí Minh','0987654321'),
('XB00003',N'Bloomsbury',N'London, UK','0044090901'),
('XB00004',N'Shinchosha',N'Tokyo, Japan','0081090902'),
('XB00005',N'Secker & Warburg',N'London, UK','0044090903'),
('XB00006',N'The Russian Messenger',N'Moscow, Russia','0079090904'),
('XB00007',N'A. Lacroix, Verboeckhoven & Cie.',N'Paris, France','0061090905'),
('XB00008',N'Editorial Sudamericana',N'Buenos Aires, Argentina','0054090906'),
('XB00009',N'HarperTorch',N'USA','0019090907');

INSERT INTO QLSACH VALUES
('S000001',N'Tôi Thấy Hoa Vàng Trên Cỏ Xanh','TG00001','TL00004','XB00001','2010-06-15',100,85),
('S000002',N'Cho Tôi Xin Một Vé Đi Tuổi Thơ','TG00001','TL00004','XB00002','2008-09-10',120,95),
('S000003',N'Harry Potter và Hòn Đá Phù Thủy','TG00002','TL00001','XB00003','1997-06-26',200,150),
('S000004',N'Rừng Na Uy','TG00003','TL00001','XB00004','1987-09-04',150,130),
('S000005',N'1984','TG00004','TL00005','XB00005','1949-06-08',180,140),
('S000006',N'Chuông Nguyện Hồn Ai','TG00005','TL00005','XB00005','1940-03-15',90,60),
('S000007',N'Chiến Tranh và Hòa Bình','TG00006','TL00001','XB00006','1869-01-01',70,55),
('S000008',N'Những Người Khốn Khổ','TG00007','TL00005','XB00007','1862-01-01',120,80),
('S000009',N'Trăm Năm Cô Đơn','TG00008','TL00001','XB00008','1967-05-30',110,75),
('S000010',N'Nhà Giả Kim','TG00009','TL00009','XB00009','1988-04-01',95,70);

INSERT INTO DOCGIA VALUES
('DG00001',N'Đỗ Thành Trung',N'Khoa Công Nghệ Thông Tin',N'14DHTH12',N'TP.HCM','0912345678','dothanhtrunf@gmail.com'),
('DG00002',N'Lê Thị Châu',N'Khoa Quản trị Kinh doanh',N'13DHKD',N'Long An','0914425125','chaithile@gmail.com'),
('DG00003',N'Nguyễn Hữu Cường',N'Khoa Tài chính - Kế toán',N'15DHKT',N'Binh Dương','0284470967','huucuong@gmail.com'),
('DG00004',N'Bùi Đắc Hoàng Phước',N'Khoa Ngoại Ngữ',N'14DHAV',N'TP.HCM','0922509415','hoangphuoc@gmail.com'),
('DG00005',N'Đinh Xuân Cường',N'Khoa Công nghệ Cơ khí',N'14DHCK',N'TP.HCM','0357721341','cuong123@gmail.com'),
('DG00006',N'Ngô Thị Hoa',N'Khoa Công nghệ Thực phẩm',N'12DHTP',N'An Giang','0967812443','hoangothi@gmail.com'),
('DG00007',N'Vũ Minh Hùng',N'Khoa Công nghệ Điện - Điện tử',N'14DHDT',N'Tiền Giang','0284043311','hungvu1@gmail.com'),
('DG00008',N'Bùi Thị Lan',N'Khoa Sinh học và Môi trường',N'12DHMT',N'TP.HCM','0354450010','buithilan@gmail.com'),
('DG00009',N'Đỗ Mạnh Quân',N'Khoa Công nghệ May và Thời trang',N'14DHTT',N'Long An','0990126641','doquan123@gmail.com'),
('DG00010',N'Phan Thị Thảo',N'Khoa Lý Luận Chính Trị',N'15DGCT',N'Bến Tre','0901254337','janny11@gmail.com');


INSERT INTO THETHUVIEN VALUES
('TH00001','DG00001','2025-01-15','2027-01-15',N'Hoạt động'),
('TH00002','DG00002','2025-02-10','2027-02-10',N'Hoạt động'),
('TH00003','DG00003','2025-03-05','2027-03-05',N'Hoạt động'),
('TH00004','DG00004','2025-04-20','2027-04-20',N'Hoạt động'),
('TH00005','DG00005','2025-05-12','2027-05-12',N'Hoạt động'),
('TH00006','DG00006','2025-06-18','2027-06-18',N'Hoạt động'),
('TH00007','DG00007','2025-07-25','2026-07-25',N'Hoạt động'),
('TH00008','DG00008','2024-08-30','2026-08-30',N'Hoạt động'),
('TH00009','DG00009','2025-09-14','2027-09-14',N'Hoạt động'),
('TH00010','DG00010','2023-10-01','2026-10-01',N'Hoạt động');

INSERT INTO QLNHANVIEN VALUES
('NV00001',N'Nguyễn Văn A','1990-05-10',N'Thủ thư','0911222333','vana@gmail.com'),
('NV00002',N'Trần Thị B','1992-07-20',N'Quản lý','0911333444','thib@gmail.com'),
('NV00003',N'Lê Văn C','1988-03-15',N'Thủ thư','0911444555','vanc@gmail.com');

INSERT INTO PHIEUMUON VALUES
('PM00001','DG00001','NV00001','2023-10-01','2023-10-15'),
('PM00002','DG00002','NV00002','2023-06-01','2023-06-15'),
('PM00003','DG00003','NV00003','2023-07-15','2023-07-30');

INSERT INTO CHITIETPM VALUES
('PM00001','S000001',2,20000),
('PM00001','S000002',1,10000),
('PM00002','S000003',1,10000),
('PM00003','S000001',1,10000),
('PM00003','S000004',3,30000);

INSERT INTO PHIEUTRA VALUES
('PT00001','PM00001','NV00001','2023-10-14',30000,0),
('PT00002','PM00002','NV00003','2023-06-11',10000,200000),
('PT00003','PM00003','NV00002','2023-08-02',40000,100000);

INSERT INTO PHONGHOP VALUES 
('PH00001',N'Tầng 3',10,1),
('PH00002',N'Tầng 3',8,1),
('PH00003',N'Tầng 3',12,1),
('PH00004',N'Tầng 3',8,1)

INSERT INTO PHIEU_MUONPHONG VALUES
('MP00001','DG00001','PH00001','2025/02/11','09:50:00',6,N'Họp nhóm',0),
('MP00002','DG00002','PH00001','2025/10/14','12:30:00',6,N'Họp nhóm và thảo luận đồ án với giảng viên hướng dẫn',0),
('MP00003','DG00001','PH00001','2025/02/11','09:50:00',6,N'Báo cáo đồ án cuối kì online',0),
('MP00004','DG00001','PH00001','2025/02/11','09:50:00',6,N'Họp nhóm',0)